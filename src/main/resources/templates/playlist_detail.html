<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link href="/css/main.css" rel="stylesheet">
    <title>Playlist Detail</title>
    <!-- JavaScript for accordion -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            var acc = document.getElementsByClassName("accordion2");
            var panel;

            for (var i = 0; i < acc.length; i++) {
                acc[i].addEventListener("click", function() {
                    this.classList.toggle("active");
                    panel = this.nextElementSibling;

                    if (panel.style.display === "block") {
                        panel.style.display = "none";
                    } else {
                        panel.style.display = "block";
                    }

                    closePanelsOutsideClick(panel);
                });
            }

            var acc3 = document.getElementsByClassName("accordion3");
            for (var i = 0; i < acc3.length; i++) {
                acc3[i].addEventListener("click", function() {
                    this.classList.toggle("active");
                    var panel2 = this.nextElementSibling;

                    if (panel2.style.display === "block") {
                        panel2.style.display = "none";
                    } else {
                        panel2.style.display = "block";
                    }

                    closePanelsOutsideClick(panel2);
                });
            }

            // 화면의 다른 부분을 클릭하면 패널을 닫는 함수
            function closePanelsOutsideClick(currentPanel) {
                document.addEventListener('click', function(event) {
                    var isClickInside = currentPanel.contains(event.target) || event.target.classList.contains('accordion2') || event.target.classList.contains('accordion3');

                    if (!isClickInside) {
                        currentPanel.style.display = "none";
                    }
                });
            }
        });
    </script>
</head>
<body>

<!-- header 부분에서 user.providerId가 null일 때 대비하여 수정 -->
<div th:replace="~{layout/header :: header}"></div>

<!-- 플레이리스트 상단 큰 이미지와 제목 -->
<div class="playlist-header">
    <!-- playlistImage가 없을 때 첫 번째 앨범 이미지 또는 기본 이미지로 설정 -->
    <img th:src="${playlistImage != null ? playlistImage : (playlist[0].album_image != null ? playlist[0].album_image : '/path/to/default-image.png')}" class="playlist-cover-image" alt="플레이리스트 이미지">
    <h1 class="playlist-title" th:text="${entry.key} + ' 때 듣는 음악'">Playlist Title</h1>
    <!-- 총 곡 수 및 총 재생 시간 표시 -->
    <p class="playlist-subtitle" th:text="'총 ' + ${totalSongs} + ' 곡 • 총 재생 시간: ' + ${totalDuration}"></p>
    <!-- 재생 버튼 -->
    <div class="play-button-container">
        <button class="play-button"></button>
    </div>
</div>

<!-- 플레이리스트에 들어있는 노래들 -->
<div class="playlist_songs">
    <table class="playlist_table">
        <tbody>
        <tr th:each="song, iterStat : ${playlist}">
            <td th:text="${iterStat.index + 1}"></td> <!-- 곡 번호 -->
            <td>
                <img th:src="${song.album_image}" alt="앨범 이미지" class="album-cover-thumbnail"> <!-- 앨범 이미지 -->
            </td>
            <td th:text="${song.musicName}"></td> <!-- 곡 이름 -->
            <td th:text="${song.musicArtistName}"></td> <!-- 아티스트 -->
            <td th:text="${formattedDurations[iterStat.index]}"></td> <!-- 미리 계산된 시간 사용 -->
            <td class="menu">
                <div class="accordion_container">
                    <button class="accordion2">:</button>
                    <div class="panel">
                        <!-- HTML 하트 버튼 추가 -->
                        <button class="like-button" th:data-album-id="${song.id}" th:data-user-id="${user != null ? user.id : 'defaultId'}">
                            <span class="heart" th:text="${song.isLiked != null ? (song.isLiked ? '♥' : '♡') : '♡'}"></span>
                        </button>
                        <button>재생 목록에 추가</button>
                        <button>다음에 재생</button>
                        <a th:href="@{/album/{detail}/{id}(detail=${song.detail}, id=${user != null ? user.id : 'defaultId'})}">
                            <button>앨범 정보</button>
                        </a>
                        <button class="accordion3">공유</button>
                        <div class="panel2">
                            <button><a href="#" onclick="clip(); return false;">링크 복사</a></button>
                            <button><a id="btnKakao" href="javascript:shareKakao();">카카오톡에 공유</a></button>
                            <button><a href="javascript:shareTwitter();">트위터에 공유</a></button>
                            <button><a href="javascript:shareFacebook();">페이스북에 공유</a></button>
                            <button><a href="javascript:shareBand();">밴드에 공유</a></button>
                        </div>
                    </div>
                </div>
            </td> <!-- 아코디언 메뉴 추가 -->
        </tr>
        </tbody>
    </table>
</div>

<div th:replace="play/under :: footer"></div>

<!-- JavaScript 코드 for like button -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const likeButtons = document.querySelectorAll('.like-button');

        likeButtons.forEach(button => {
            button.addEventListener('click', function () {
                const albumId = this.getAttribute('data-album-id');
                const userId = this.getAttribute('data-user-id');

                // 서버에 AJAX 요청을 보내서 좋아요 상태 변경
                fetch(`/mypage/like/album/toggleTrack?albumId=${albumId}&userId=${userId}`, {
                    method: 'POST',
                })
                    .then(response => response.text())
                    .then(result => {
                        const heartSpan = this.querySelector('.heart');
                        if (result === 'liked') {
                            heartSpan.textContent = '♥';  // 하트를 채워진 상태로 변경
                        } else {
                            heartSpan.textContent = '♡';  // 하트를 빈 상태로 변경
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            });
        });
    });
</script>

</body>
</html>
